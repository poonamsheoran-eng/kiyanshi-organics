<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kiyanshi Organics - Admin</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 30px; }
        h1 { margin-bottom: 5px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { background: #fbbf24; border: none; padding: 8px 14px; cursor: pointer; border-radius: 6px; font-weight: bold; margin-right: 5px; }
        .danger { background: #ef4444; color: white; }
        table { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; }
        th { text-align: left; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; }
        .modal-content { background: white; width: 400px; margin: 100px auto; padding: 20px; border-radius: 8px; }
        .modal input { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <h1>Kiyanshi Organics</h1>
        <p>Admin Panel - Product Management</p>
    </div>
    <div>
        <button class="btn" onclick="goToOrders()">ðŸ“¦ View Orders</button>
        <button class="btn danger" onclick="logout()">ðŸšª Logout</button>
    </div>
</div>

<button class="btn" onclick="openForm()">+ Add New Product</button>

<table>
    <thead>
        <tr>
            <th>Product Name</th>
            <th>Quantity in Stock</th>
            <th>Price</th>
            <th>Unit</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="productTable">
        <tr><td colspan="5" style="text-align:center;padding:20px">Loading products...</td></tr>
    </tbody>
</table>

<!-- MODAL -->
<div class="modal" id="productModal">
    <div class="modal-content">
        <h3 id="modalTitle">Add Product</h3>
        <input type="hidden" id="productId">
        <input id="name" placeholder="Product Name">
        <input id="qty" type="number" placeholder="Quantity">
        <input id="price" type="number" step="0.01" placeholder="Price">
        <input id="unit" placeholder="Unit (kg / pcs / litre)">
        <button class="btn" onclick="saveProduct()">Save</button>
        <button onclick="closeForm()">Cancel</button>
    </div>
</div>

<script>
const API_URL = '/api';
const mobile = sessionStorage.getItem("mobile") || localStorage.getItem("mobile");
const role = sessionStorage.getItem("role");

if (!mobile || role !== 'admin') {
    alert("Admin access only");
    window.location.href = "index.html";
}

function openForm() {
    document.getElementById("modalTitle").innerText = "Add Product";
    clearForm();
    document.getElementById("productModal").style.display = "block";
}

function closeForm() {
    document.getElementById("productModal").style.display = "none";
}

function clearForm() {
    document.getElementById("productId").value = "";
    document.getElementById("name").value = "";
    document.getElementById("qty").value = "";
    document.getElementById("price").value = "";
    document.getElementById("unit").value = "";
}

function loadProducts() {
    fetch(`${API_URL}/products`)
        .then(res => res.json())
        .then(products => {
            const table = document.getElementById("productTable");
            table.innerHTML = "";
            
            if (products.length === 0) {
                table.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px">No products added yet</td></tr>';
                return;
            }
            
            products.forEach(p => {
                const safeName = String(p.name).replace(/'/g, "\\'");
                const safeUnit = String(p.unit).replace(/'/g, "\\'");
                table.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.quantity}</td>
                        <td>â‚¹${p.price}</td>
                        <td>${p.unit}</td>
                        <td>
                            <button class="btn" onclick="editProduct(${p.id}, '${safeName}', ${p.quantity}, ${p.price}, '${safeUnit}')">Edit</button>
                            <button class="btn danger" onclick="deleteProduct(${p.id}, '${safeName}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
        })
        .catch(err => {
            console.error(err);
            document.getElementById("productTable").innerHTML = 
                '<tr><td colspan="5" style="text-align:center;padding:20px;color:red">Error loading products</td></tr>';
        });
}

function editProduct(id, name, qty, price, unit) {
    document.getElementById("modalTitle").innerText = "Edit Product";
    document.getElementById("productId").value = id;
    document.getElementById("name").value = name;
    document.getElementById("qty").value = qty;
    document.getElementById("price").value = price;
    document.getElementById("unit").value = unit;
    document.getElementById("productModal").style.display = "block";
}

function saveProduct() {
    const id = document.getElementById("productId").value;
    const name = document.getElementById("name").value.trim();
    const quantity = document.getElementById("qty").value;
    const price = document.getElementById("price").value;
    const unit = document.getElementById("unit").value.trim();

    if (!name || !quantity || !price || !unit) {
        alert("Please fill all fields");
        return;
    }

    const data = { 
        mobile, 
        name, 
        quantity: parseFloat(quantity), 
        price: parseFloat(price), 
        unit 
    };

    // FIXED: Use PUT for edit, POST for new
    const url = id ? `${API_URL}/admin/products/${id}` : `${API_URL}/admin/products`;
    const method = id ? "PUT" : "POST";

    fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.error) {
            alert("Error: " + result.error);
        } else {
            alert(id ? "Product updated!" : "Product added!");
            closeForm();
            clearForm();
            loadProducts();
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error saving product");
    });
}

function deleteProduct(id, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

    fetch(`${API_URL}/admin/products/${id}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mobile })
    })
    .then(res => res.json())
    .then(result => {
        if (result.error) {
            alert("Error: " + result.error);
        } else {
            alert("Product deleted");
            loadProducts();
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error deleting product");
    });
}

function goToOrders() {
    window.location.href = "admin_orders.html";
}

function logout() {
    if (confirm("Are you sure you want to logout?")) {
        sessionStorage.clear();
        localStorage.removeItem("mobile");
        window.location.href = "index.html";
    }
}

window.onload = loadProducts;
</script>

</body>
</html>
